# Column Hints System - User Guide

## Overview

The **Column Hints System** provides a persistent, user-editable dictionary that maps technical database columns to business-friendly terms. This enables accurate Natural Language to SQL (NL-to-SQL) query generation.

## Key Features

✅ **Persistent Storage**: JSON-based storage with versioning
✅ **User Editable**: Full CRUD operations via REST API
✅ **LLM Integration**: Auto-generate hints using AI
✅ **Search & Discovery**: Fast search across business terms
✅ **Version Control**: Snapshot and restore capabilities
✅ **Audit Trail**: Track who changed what and when

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     Hints Dictionary                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  schemas/hints/column_hints.json  ←→  REST API  ←→  Users   │
│                                            ↕                 │
│                                       Knowledge Graph        │
│                                            ↕                 │
│                                      NL-to-SQL Engine        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## File Structure

```
schemas/hints/
├── column_hints.json           # Main hints dictionary
├── column_hints_backup.json    # Automatic backup
└── versions/
    ├── column_hints_v1.json    # Version snapshots
    ├── column_hints_v2.json
    └── metadata.json           # Version history
```

---

## Hints Dictionary Schema

### Table-Level Hints

```json
{
  "table_hints": {
    "business_name": "Material Master Data",
    "aliases": ["materials", "products", "items"],
    "description": "Central repository for material information",
    "category": "master_data",
    "user_notes": "Main table for material queries",
    "last_edited_by": "user@example.com",
    "last_edited_at": "2025-11-04T10:30:00Z"
  }
}
```

### Column-Level Hints

```json
{
  "MATERIAL": {
    "business_name": "Material Number",
    "aliases": ["product_id", "item_code", "sku"],
    "description": "Unique identifier for materials",
    "semantic_type": "identifier",
    "data_type": "NVARCHAR(18)",
    "role": "primary_identifier",
    "common_terms": ["material", "product", "item"],
    "examples": ["MAT001234", "PRD-567890"],
    "allowed_values": null,
    "searchable": true,
    "filterable": true,
    "aggregatable": false,
    "priority": "high",
    "default_filter": null,
    "business_rules": ["Always 18 characters"],
    "user_notes": "Primary key for lookups",
    "auto_generated": false,
    "manual_verified": true,
    "last_edited_by": "user@example.com",
    "last_edited_at": "2025-11-04T09:15:00Z"
  }
}
```

### Field Definitions

| Field | Type | Description |
|-------|------|-------------|
| `business_name` | string | Human-friendly name for the column |
| `aliases` | array | Alternative names users might use |
| `description` | string | What this column represents |
| `semantic_type` | enum | identifier, measure, dimension, date, flag, description |
| `role` | enum | primary_key, foreign_key, attribute, calculated |
| `common_terms` | array | Natural language terms users ask for |
| `examples` | array | Sample values from the column |
| `allowed_values` | array | Valid values (for enums/lookups) |
| `searchable` | boolean | Can be used in search queries |
| `filterable` | boolean | Can be used in WHERE clauses |
| `aggregatable` | boolean | Can be used with COUNT, SUM, etc. |
| `priority` | enum | high, medium, low (for ranking) |
| `default_filter` | string | Default filter value (e.g., "Active") |
| `business_rules` | array | Business rules about this column |
| `user_notes` | string | User-added notes |
| `auto_generated` | boolean | Generated by LLM vs manual |
| `manual_verified` | boolean | Verified by a user |

---

## REST API Endpoints

### Get Hints

```bash
# Get all hints
GET /api/kg/hints/

# Get hints for a table
GET /api/kg/hints/table/{table_name}

# Get hints for a column
GET /api/kg/hints/column/{table_name}/{column_name}

# Get statistics
GET /api/kg/hints/statistics
```

### Update Hints

```bash
# Update table hints
POST /api/kg/hints/table
{
  "table_name": "hana_material_master",
  "user": "john@example.com",
  "hints": {
    "business_name": "Material Master",
    "aliases": ["materials", "products"]
  }
}

# Update column hints
POST /api/kg/hints/column
{
  "table_name": "hana_material_master",
  "column_name": "MATERIAL",
  "user": "sarah@example.com",
  "hints": {
    "business_name": "Material Number",
    "aliases": ["product", "item"],
    "priority": "high"
  }
}

# Update a single field
PATCH /api/kg/hints/column/{table_name}/{column_name}/{field_name}
{
  "field_value": "high",
  "user": "admin@example.com"
}
```

### Search Hints

```bash
POST /api/kg/hints/search
{
  "search_term": "material",
  "limit": 10
}
```

### Delete Hints

```bash
# Delete column hints
DELETE /api/kg/hints/hints
{
  "table_name": "hana_material_master",
  "column_name": "MATERIAL",
  "user": "admin@example.com"
}

# Delete entire table hints
DELETE /api/kg/hints/hints
{
  "table_name": "hana_material_master",
  "user": "admin@example.com"
}
```

### Version Control

```bash
# Create version snapshot
POST /api/kg/hints/version
{
  "version_name": "v1.0_initial",
  "user": "admin@example.com",
  "comment": "Initial version"
}
```

### LLM Generation

```bash
# Generate hints for one column
POST /api/kg/hints/generate
{
  "table_name": "hana_material_master",
  "column_name": "OPS_STATUS",
  "column_type": "NVARCHAR(50)",
  "sample_values": ["Active", "Inactive"],
  "user": "system"
}

# Bulk generate for all columns in a table
POST /api/kg/hints/generate/bulk
{
  "table_name": "hana_material_master",
  "schema_path": "schemas/newdqschemanov.json",
  "user": "system",
  "overwrite_existing": false
}
```

### Export/Import

```bash
# Export hints
GET /api/kg/hints/export?output_path=schemas/hints/backup.json

# Import hints
POST /api/kg/hints/import
{
  "input_path": "schemas/hints/backup.json",
  "merge": true,
  "user": "admin@example.com"
}
```

---

## Usage Workflows

### Workflow 1: Initial Setup

```bash
# Step 1: Generate hints for all tables using LLM
POST /api/kg/hints/generate/bulk
{
  "table_name": "hana_material_master",
  "schema_path": "schemas/newdqschemanov.json",
  "overwrite_existing": false
}

# Step 2: Create initial version snapshot
POST /api/kg/hints/version
{
  "version_name": "v1.0_autogenerated",
  "user": "admin",
  "comment": "Auto-generated hints via LLM"
}
```

### Workflow 2: Manual Refinement

```bash
# Step 1: Review auto-generated hints
GET /api/kg/hints/column/hana_material_master/MATERIAL

# Step 2: Update specific fields
PATCH /api/kg/hints/column/hana_material_master/MATERIAL/aliases
{
  "field_value": ["product", "item", "sku", "part"],
  "user": "domain_expert@example.com"
}

# Step 3: Mark as verified
PATCH /api/kg/hints/column/hana_material_master/MATERIAL/manual_verified
{
  "field_value": true,
  "user": "domain_expert@example.com"
}
```

### Workflow 3: NL Query Processing

```python
from kg_builder.services.hint_manager import get_hint_manager

# User asks: "Show me all active materials"
hint_manager = get_hint_manager()

# Search for relevant columns
active_cols = hint_manager.search_hints("active")
material_cols = hint_manager.search_hints("material")

# Found:
# - hana_material_master.OPS_STATUS (matched "active")
# - hana_material_master.MATERIAL (matched "material")

# Generate SQL using hints
sql = """
SELECT MATERIAL, OPS_STATUS
FROM hana_material_master
WHERE OPS_STATUS = 'Active'
"""
```

---

## Best Practices

### 1. **Start with LLM Generation**
- Use bulk generation for initial setup
- Review and refine auto-generated hints

### 2. **Add Business Context**
- Include domain-specific aliases
- Document business rules
- Add real examples from your data

### 3. **Maintain Consistency**
- Use consistent naming conventions
- Keep aliases lowercase
- Use semantic types consistently

### 4. **Version Control**
- Create snapshots before major changes
- Add meaningful comments to versions
- Export backups regularly

### 5. **Collaborate**
- Include user attribution
- Document changes in user_notes
- Review hints with domain experts

### 6. **Optimize for Search**
- Add common misspellings to aliases
- Include both technical and business terms
- Use common_terms for natural language phrases

---

## Integration with NL-to-SQL

The hints system integrates with NL-to-SQL query generation:

1. **User Query**: "Show me all discontinued GPU products"

2. **Hint Matching**:
   - "discontinued" → `OPS_STATUS` (via common_terms)
   - "GPU" → `Product_Line` (via aliases)
   - "products" → `MATERIAL` (via aliases)

3. **Context Building**:
   ```
   Table: hana_material_master
   Columns:
   - MATERIAL (identifier, aliases: product, item)
   - OPS_STATUS (dimension, allowed_values: Active, Inactive, Discontinued)
   - Product_Line (dimension, aliases: product line, GPU, NBU)
   ```

4. **SQL Generation**:
   ```sql
   SELECT MATERIAL, OPS_STATUS, "Product Line"
   FROM hana_material_master
   WHERE OPS_STATUS = 'Discontinued'
     AND "Product Line" LIKE '%GPU%'
   ```

---

## Troubleshooting

### Hints not appearing in search?

Check `searchable: true` and verify aliases/common_terms are populated.

### LLM generation failing?

Ensure `OPENAI_API_KEY` is set in environment variables.

### Version snapshots not created?

Check write permissions for `schemas/hints/versions/` directory.

### Import/export errors?

Verify file paths are absolute or relative to project root.

---

## Advanced Features

### Custom Semantic Types

Add custom semantic types in `global_hints`:

```json
{
  "global_hints": {
    "semantic_type_definitions": {
      "identifier": "Unique keys",
      "measure": "Numeric values",
      "custom_type": "Your custom type definition"
    }
  }
}
```

### Pattern-Based Hints

Define patterns for auto-detection:

```json
{
  "global_hints": {
    "common_patterns": {
      "_uid": "Unique identifier",
      "_code": "Classification code",
      "_date": "Date field"
    }
  }
}
```

---

## Support

For issues or questions:
- Check the API documentation
- Review usage examples in `examples/hints_usage_examples.py`
- Consult the service code in `kg_builder/services/hint_manager.py`
